# Паттерн Proxy (заместитель)

## Название и классификация паттерна

**Заместитель** — паттерн, структурирующий объекты.

## Назначение

Является суррогатом другого объекта и контролирует доступ к нему.

## Другие названия

**Surrogate** (суррогат).

## Мотивация

Одна из причин для управления доступом к объекту — возможность отложить затраты на создание и инициализацию до момента, когда возникнет фактическая необходимость в объекте. Рассмотрим редактор документов, в котором в документы могут встраиваться графические объекты. Затраты на создание некоторых таких объектов (например, больших растровых изображений) могут быть весьма значительными. Но документ должен открываться быстро, поэтому следует избегать создания всех «тяжелых» объектов на стадии открытия (и вообще это излишне, поскольку не все они будут видны одновременно).

В связи с такими ограничениями кажется разумным создавать «тяжелые» объекты *по требованию*. Это означает «когда изображение становится видимым». Но что поместить в документ вместо изображения? И как без усложнения реализации редактора скрыть тот факт, что изображение создается по требованию? Например, оптимизация не должна отражаться на коде, отвечающем за рисование и форматирование.

Решение состоит в том, чтобы использовать другой объект — *заместитель* изображения, который временно подставляется вместо реального изображения. Заместитель ведет себя точно так же, как само изображение, и при необходимости создает его экземпляр.

ИЗОБРАЖЕНИЕ

**Заместитель** создает настоящее изображение, только если редактор документа вызовет операцию `Draw`. Все последующие запросы заместитель переадресует непосредственно изображению. Поэтому после создания изображения он должен сохранить ссылку на него.

Предположим, что изображения хранятся в отдельных файлах. В таком случае мы можем использовать имя файла как ссылку на реальный объект. Заместитель хранит также размер изображения, то есть длину и ширину. «Зная» ее, заместитель может отвечать на запросы форматера о своем размере, не создавая экземпляр изображения.

На следующей диаграмме классов этот пример показан более подробно.

ИЗОБРАЖЕНИЕ

Редактор документов получает доступ к встроенным изображениям только через интерфейс, определенный в абстрактном классе `Graphic`. `ImageProxy` — это класс для представления изображений, создаваемых по требованию. В `ImageProxy` хранится имя файла, играющее роль ссылки на изображение, которое находится на диске. Имя файла передается конструктору класса `ImageProxy`.

В объекте `ImageProxy` находятся также ограничивающий прямоугольник изображения и ссылка на экземпляр реального объекта `Image`. Ссылка остается недействительной, пока заместитель не создаст экземпляр реального изображения. Операция `Draw` гарантирует, что изображение будет создано до того, как заместитель переадресует ему запрос. Операция `GetExtent` переадресует запрос изображению, только если его экземпляр уже создан; в противном случае `ImageProxy` возвращает те размеры, которые хранит сам.

## Применимость

Паттерн **заместитель** применим во всех случаях, когда возникает необходимость сослаться на объект более гибким или нетривиальным способом, чем при использовании простого указателя. Несколько типичных ситуаций, в которых **заместитель** может оказаться полезным:

* *удаленный заместитель* предоставляет локального представителя для объекта, находящегося в другом адресном пространстве. В системе NEXTSTEP \[Add94\] для этой цели применяется класс `NXProxy`. Заместителя такого рода Джеймс Коплиен \[Cop92\] называет «послом» (Ambassador);
* *виртуальный заместитель* создает «тяжелые» объекты по требованию. Примером может служить класс `ImageProxy`, описанный в разделе [«Мотивация»](#мотивация);
* *защищающий заместитель* контролирует доступ к исходному объекту. Такие заместители полезны, когда для разных объектов определены различные права доступа. Например, в операционной системе Choices \[CIRM93\] объекты `KernelProxy` ограничивают права доступа к объектам операционной системы;
* *«умная» ссылка* — это замена обычного указателя. Она позволяет выполнить дополнительные действия при доступе к объекту. К типичным применениям такой ссылки можно отнести:

	* подсчет числа ссылок на реальный объект, с тем чтобы занимаемую им память можно было освободить автоматически, когда не останется ни одной ссылки (такие ссылки называют еще «умными» указателями \[Ede92\]);
	* загрузку объекта из долгосрочного хранилища в память при первом обращении к нему;
	* проверку и установку блокировки на реальный объект при обращении к нему, чтобы никакой другой объект не смог в это время изменить его.

## Структура

ИЗОБРАЖЕНИЕ

Вот как может выглядеть схема объектов для структуры с заместителем во время выполнения.

## Участники

* **Proxy** (`ImageProxy`) — заместитель:

	* хранит ссылку, которая позволяет заместителю обратиться к реальному субъекту. Объект класса `Proxy` может обращаться к объекту класса `Subject`, если интерфейсы классов `RealSubject` и `Subject` одинаковы;
	* предоставляет интерфейс, идентичный интерфейсу `Subject`, так что заместитель всегда может быть подставлен вместо реального субъекта;
	* контролирует доступ к реальному субъекту и может отвечать за его создание и удаление;
	* прочие обязанности зависят от вида заместителя:

		* *удаленный заместитель* отвечает за кодирование запроса и его аргументов и отправление закодированного запроса реальному субъекту в другом адресном пространстве;
		* *виртуальный заместитель* может кэшировать дополнительную информацию о реальном субъекте, чтобы отложить его создание. Например, класс `ImageProxy` из раздела [«Мотивация»](#мотивация) кэширует размеры реального изображения;
		* *защищающий заместитель* проверяет, имеет ли вызывающий объект необходимые для выполнения запроса права;

* **Subject** (`Graphic`) — субъект:

	* определяет общий для `RealSubject` и `Proxy` интерфейс, так что класс `Proxy` можно использовать везде, где ожидается `RealSubject`;

* **RealSubject** (`Image`) — реальный субъект:

	* определяет реальный объект, представленный заместителем.

## Отношения

`Proxy` при необходимости переадресует запросы объекту `RealSubject`. Детали зависят от вида заместителя.

# Результаты

С помощью паттерна **заместитель** при доступе к объекту вводится дополнительный уровень косвенности. У этого подхода есть много вариантов в зависимости от вида заместителя:

* удаленный заместитель может скрыть тот факт, что объект находится в другом адресном пространстве
* виртуальный заместитель может выполнять оптимизацию, например создание объекта по требованию;
* защищающий заместитель и «умная» ссылка позволяют решать дополнительные задачи при доступе к объекту.

Есть еще одна оптимизация, которую паттерн **заместитель** иногда скрывает от клиента. Она называется *копированием при записи* (copy-on-write) и имеет много общего с созданием объекта по требованию. Копирование большого и сложного объекта — очень затратная операция. Если копия не модифицировалась, то нет смысла эту цену платить. Если отложить процесс копирования, применив паттерн **заместитель**, то можно быть уверенным, что эта операция произойдет только тогда, когда он действительно был изменен.

Чтобы во время записи можно было копировать, необходимо подсчитывать ссылки на субъект. Копирование заместителя просто увеличивает счетчик ссылок. И только тогда, когда клиент запрашивает операцию, изменяющую субъект, заместитель действительно выполняет копирование. Одновременно заместитель должен уменьшить счетчик ссылок. Когда счетчик ссылок становится равным нулю, субъект уничтожается.

Копирование при записи может существенно уменьшить плату за копирование «тяжелых» субъектов.
